<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="pending-requests">
    <template>
        <style is="custom-style">
            section {
                width: 100%;
                height: 250px;
                @apply(--layout-vertical);
            }

            section paper-dialog-scrollable {

                @apply(--layout-flex);
            }

            paper-dialog-scrollable::shadow #scrollable {
                padding: 0px;
            }

            paper-item {
                --paper-item: {
                    cursor: pointer;
                };
            }

            #name {
                padding-left: 10px;
                padding-right: 10px;
            }

            span {
                padding-right: 10px;
            }

            paper-listbox {
                width: 100%;
            }
        </style>
        <section>
            <firebase-collection
                    location="https://brainlight.firebaseio.com/requests"
                    data="{{requests}}">
            </firebase-collection>
            <paper-dialog-scrollable>
                <paper-listbox  id="requestList" selected="{{myChoice}}">
                    <template is="dom-repeat" items="[[requests]]" as="req"> <!--  sort="_computeSort"-->
                        <paper-item>
                            <!-- <img src={{online(usr)}} style="width:10px;height:10px;">-->
                            <!--  <img src="../../../images/offline.png" style="width:10px;height:10px;">-->
                            <div id="name"> {{getName(req.userKey)}} </div>
                            <span> - </span>
                            <div id="number">{{getNumber(req.userKey)}}</div>
                        </paper-item>
                    </template>
                </paper-listbox>
            </paper-dialog-scrollable>
        </section>
        </app-grid>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'pending-requests',

                properties: {
                    selected: Array,
                    requests: {
                        type: Object,
                        notify: true
                    },
                    myChoice: {
                        type: Number,
                        notify: true,
                        observer: '_onRequestSelected'
                    },
                    deletedRequestKey: {
                        type: Number,
                        notify: true
                    },
                    currentKey: {
                        type: Number,
                        notify: true
                    }

                },

                getName: function(usrKey) {
                    var ref = new Firebase(app.userURL(usrKey));
                    var name;

                    ref.on("value",function(snapshot){
                        var user = snapshot.val();
                        name = user.name + " " + user.lastname;
                    });
                    return name;
                },


                getNumber: function(usrKey) {
                    var ref = new Firebase(app.userURL(usrKey));
                    var number;

                    ref.on("value",function(snapshot){
                        var user = snapshot.val();
                        number = user.number;
                    });
                    return number;
                },
                ready: function () {
                    var appRef = new Firebase(app.requestsLocation);
                    var self = this;

                    appRef.on('child_removed', function (oldChildSnapshot) {
                        self.deletedRequestKey = oldChildSnapshot.key();
                    });
                },

                _onRequestSelected: function () {
                    var request = this.requests[this.myChoice];
                    this.currentKey = request
                    this.fire('selected-request', request);
                    // alert(JSON.stringify(request));
                },

                itemSelected: function () {
                    if (this.deletedRequestKey == this.currentKey) {
                        var request = this.requests[this.myChoice];
                        this.fire('selected-request', request);
                    } else {
                        this.myChoice -= 1;
                    }
                }
            });
        })();
    </script>
</dom-module>