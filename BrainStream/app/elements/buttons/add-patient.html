<!--
   @license
   Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
   This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
   The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
   The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
   Code distributed by Google as part of the polymer project is also
   subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
   -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="add-patient">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
            }
            #modal{
                width: 350px;
            }
            .containerdiv {
                @apply(--layout-horizontal);
                height: 100%;
                width: 100%;
                padding-right: 0px;
                font-size: 12px;
            }
            #genpw{
                margin-top: 16px;
            }
            .flexchild {
                @apply(--layout-flex);
            }
            #genderdrop{
                @apply(--layout-horizontal);
            }
        </style>
        <paper-icon-button data-dialog="modal" icon="icons:add" on-click="clickHandler"></paper-icon-button>
        <paper-dialog id="newPacientDialog" modal>
            <h1>Add new Patient</h1>
                <firebase-collection
                    order-by-child="groups/group2"
                    order-value-type="boolean"
                    equal-to="true"
                    location="https://brainlight.firebaseio.com/users"
                    data="{{users}}">
                </firebase-collection>
            <paper-dropdown-menu label="Doctor associated" id="doctorAssociated">
                <paper-listbox  class="dropdown-content" selected="{{myChoice}}">
                    <template is="dom-repeat" items="[[users]]" as="usr">
                        <paper-item>
                            <div required auto-validate>[[usr.name]] [[usr.lastname]]</div>
                        </paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <form is="iron-form" id="newuserform">
                <paper-input id="firstname" name="firstname" label="First Name" char-counter maxlength="10" auto-validate pattern="[a-zA-Z]*" error-message="letters only!" required auto-validate></paper-input>
                <paper-input id="lastname" name="lastname" label="Last Name" char-counter maxlength="10" auto-validate pattern="[a-zA-Z]*" error-message="letters only!" required auto-validate></paper-input>
                <paper-input id="unumber" name="unumber" label="Number" auto-validate pattern="[0-9]*" error-message="numbers only!" required auto-validate></paper-input>
                <div class="containerdiv">
                    <div class="flexchild">
                        <paper-input name="password" id="pwinput" label="Password" minlength="6" required auto-validate></paper-input>
                    </div>
                    <paper-icon-button id="genpw" icon="icons:create" on-tap="generatePW"></paper-icon-button>
                </div>
                <paper-dropdown-menu id="genderdrop" required auto-validate on-iron-select="_itemSelected" label="Gender">
                    <paper-listbox class="dropdown-content">
                        <paper-item>Female</paper-item>
                        <paper-item>Male</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-button raised on-tap="_nativeSubmit" id="newuserformSubmit">
                    <paper-spinner id="spinner" hidden></paper-spinner>
                    Submit
                </paper-button>
                <paper-button raised on-tap="_reset">Reset</paper-button>
                <div class="output"></div>
            </form>
            <div class="buttons">
                <paper-button id="closeButton" on-tap="_reset" dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'add-patient',

                properties: {
                    newPatient: {
                        type: Object,
                        notify: true
                    },
                    myChoice: {
                        type: Number,
                        notify: true
                    },
                    users: {
                        type: Array,
                        notify: true
                    }
                },

                setNewPatient: function() {
                    this.newPatient = {
                        doctorAssociated: this.users[this.myChoice].__firebaseKey__,
                        name: this.$.firstname.value,
                        lastname: this.$.lastname.value,
                        //picture: this.user.google.cachedUserProfile.picture,
                        number: this.$.unumber.value,
                        gender: this.$.genderdrop.value,
                        historicDays: 120,
                        groups: {
                            group3: true
                        },
                        online: false,
                        notes: ""
                    };

                    return this.newPatient;
                },

                _itemSelected : function(e) {
                    this.$.genderdrop.validate();
                },

                addPatient: function() {
                    var ref = new Firebase(app.usersLocation);
                    var groupRef = new Firebase(app.location + '/groups/group3/members');
                    var patient = this.setNewPatient();
                    var userRef = ref.push();
                    userRef.set(patient);
                    groupRef.child(userRef.key()).set({
                        in_group: true
                    });
                },

                _nativeSubmit: function(event) {
                    var self = this;

                    if(this.$.newuserform.validate()) {
                        // Create an account for the new user in the database
                        var appRef = new Firebase(app.location);
                        var patientNumber = this.$.unumber.value;
                        appRef.createUser({
                            email: patientNumber + "@brainstream.com",
                            password: this.$.pwinput.value
                        }, function(error, userData) {
                            if(error) {
                                alert('Error');
                            } else {
                                self.addPatient();
                                self.$.newuserform.reset();
                                self.$.newPacientDialog.close();
                            }
                        });
                    }
                },

                clickHandler:function(e) {
                    this.$.newPacientDialog.toggle();
                },

                _reset:function() {
                    document.getElementById('newuserform').reset();
                },

                generatePW:function() {
                    var chars = "abcdefghijklmnopqrstuvwxyz_-ABCDEFGHIJKLMNOP1234567890";
                    var pass = "";
                    for (var x = 0; x < 6; x++) {
                        var i = Math.floor(Math.random() * chars.length);
                        pass += chars.charAt(i);
                    }
                    this.$.pwinput.value = pass;
                },

            });
        })();
    </script>
</dom-module>