<!--
   @license
   Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
   This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
   The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
   The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
   Code distributed by Google as part of the polymer project is also
   subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
   -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="delete-all-readings">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
            }

            #modal {
                width: 350px;
            }

            .containerdiv {
                @apply(--layout-horizontal);
                height: 100%;
                width: 100%;
                padding-right: 0px;
                font-size: 12px;
            }

            #genpw {
                margin-top: 16px;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            #genderdrop {
                @apply(--layout-horizontal);
            }
        </style>
        <paper-icon-button hidden$="{{compute(ishidden)}}" data-dialog="modal" icon="icons:cancel"
                           on-click="deleteFormClickHandler"></paper-icon-button>
        <paper-dialog id="deleteDialog" modal>
            <h1>Delete</h1>

            <h2>Are you sure you want to delete all readings from this patient?</h2>

            <paper-button raised on-tap="_nativeSubmit">
                <paper-spinner id="spinner" hidden></paper-spinner>
                Delete
            </paper-button>
            <div class="buttons">
                <paper-button id="closeButton" dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'delete-all-readings',
                properties: {
                    reading: {
                        type: Object,
                        notify: true
                    },
                    selected: {
                        type: Number,
                        notify: true
                    },
                    ishidden: {
                        type: Boolean,
                        value: true
                    }
                },

                _nativeSubmit: function (event) {
                    var self = this;
                    var onDeleted = function (error) {
                        if (error) {
                            alert('An error occurred while deleting the reading!');
                        } else {
                            // Close the modal
                            self.$.deleteDialog.close();
                        }
                    };

                    var readingRef;
                    var ref = new Firebase("https://brainlight.firebaseio.com/leiturasinfo");
                    var refInfoDelete;
                    var patientToDeleteHistoric;


                    ref.on("value", function (snapshot) {
                        snapshot.forEach(function (childSnapshot) {
                            if (childSnapshot.val().Leitura == self.reading) {
                                patientToDeleteHistoric = childSnapshot.val().Patient;
                            }
                        });


                        snapshot.forEach(function (childSnapshot) {
                            if (childSnapshot.val().Patient == patientToDeleteHistoric) {
                                refInfoDelete = new Firebase("https://brainlight.firebaseio.com/leiturasinfo/" + childSnapshot.key());
                                readingRef = new Firebase("https://brainlight.firebaseio.com/leituras/" + childSnapshot.val().Leitura);
                                refInfoDelete.remove(onDeleted);
                                readingRef.remove(onDeleted);
                            }
                        });
                    });
                },
                deleteFormClickHandler: function (e) {
                    this.$.deleteDialog.toggle();
                },
                ready: function () {
                    var self = this;
                    var readingdef = false;
                    addEventListener('selected-hist-emotiv', function (defs) {
                        self.reading = defs.detail[1];
                        if (!readingdef) {
                            self.toggle();
                            readingdef = true;
                        }
                    });

                    addEventListener('selected-hist', function (reading) {
                        self.reading = reading.detail;
                        if (!readingdef) {
                            self.toggle();
                            readingdef = true;
                        }
                    });
                },
                compute: function () {
                    return this.ishidden;
                },

                toggle: function () {
                    this.ishidden = !this.ishidden;
                }
            });
        })();
    </script>
</dom-module>